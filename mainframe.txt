**[mainframe]**

==== src\battery_model.py ====

# battery_model.py
#
# ç”µæ±  SOCâ€“æ¸©åº¦ Tb è¿ç»­æ—¶é—´åŠ¨åŠ›ç³»ç»Ÿ
#
# æ”¯æŒä¸¤ç§æ•°å€¼ç§¯åˆ†æ–¹æ³•ï¼š
#   - Eulerï¼ˆæ˜¾å¼ä¸€é˜¶ï¼‰
#   - RK4ï¼ˆå››é˜¶ Rungeâ€“Kuttaï¼‰
#
# ç”¨äºä»¿çœŸæ‰‹æœºåœ¨ä¸åŒä½¿ç”¨çŠ¶æ€ä¸‹çš„ç”µé‡ä¸æ¸©åº¦æ¼”åŒ–

import math


class BatteryModel:
    """
    è¿ç»­æ—¶é—´ç”µæ± æ¨¡å‹

    çŠ¶æ€å˜é‡ï¼š
        SOC : ç”µæ± è·ç”µçŠ¶æ€ï¼ˆ0~1ï¼‰
        Tb  : ç”µæ± å†…éƒ¨å¹³å‡æ¸©åº¦ï¼ˆKï¼‰

    æ”¯æŒç§¯åˆ†æ–¹æ³•ï¼š
        method="euler" ï¼šæ˜¾å¼æ¬§æ‹‰æ³•
        method="rk4"   ï¼šå››é˜¶ Rungeâ€“Kutta
    """

    def __init__(
        self,
        SOC0=1.0,
        Tb0=298.15,
        E0=18.0 * 3600,     # æ ‡ç§°èƒ½é‡ï¼ˆJï¼‰
        C_th=60.0,         # ç­‰æ•ˆçƒ­å®¹ï¼ˆJ/Kï¼‰
        h=1.0,             # æ•£çƒ­ç³»æ•°ï¼ˆW/Kï¼‰
        eta_heat=0.85,     # åŠŸè€—è½¬åŒ–ä¸ºçƒ­çš„æ¯”ä¾‹
        T_ref=298.15,     # å‚è€ƒæ¸©åº¦ï¼ˆKï¼‰
        alpha=0.03,       # ä½æ¸©å®¹é‡æ•æ„Ÿç³»æ•°
        aging_loss=0.1    # è€åŒ–æŸå¤±æ¯”ä¾‹ Î´
    ):

        # ===== çŠ¶æ€å˜é‡ =====
        self.SOC = SOC0
        self.Tb = Tb0

        # ===== ç”µæ± ä¸çƒ­å­¦å‚æ•° =====
        self.E0 = E0
        self.C_th = C_th
        self.h = h
        self.eta_heat = eta_heat

        # ===== æ¸©åº¦ä¸è€åŒ– =====
        self.T_ref = T_ref
        self.alpha = alpha
        self.fA = 1.0 - aging_loss   # è€åŒ–ä¿®æ­£å› å­


    # =====================================================
    # ç‰©ç†å­æ¨¡å‹
    # =====================================================

    def temperature_factor(self, Tb):
        """
        æ¸©åº¦ä¿®æ­£å› å­ f_T(Tb)

        å½“æ¸©åº¦ä½äºå‚è€ƒå€¼æ—¶ï¼Œå®¹é‡æŒ‡æ•°ä¸‹é™ï¼›
        é«˜æ¸©ä¸é¢å¤–å¢åŠ å®¹é‡ã€‚
        """

        if Tb >= self.T_ref:
            return 1.0
        else:
            return math.exp(-self.alpha * (self.T_ref - Tb))

    def effective_energy(self, Tb):
        """
        è®¡ç®—æ¸©åº¦ + è€åŒ–ä¿®æ­£åçš„æœ‰æ•ˆå¯ç”¨èƒ½é‡
        """

        return self.E0 * self.temperature_factor(Tb) * self.fA

    def _derivatives(self, SOC, Tb, P_tot, T_amb):
        """
        è¿ç»­åŠ¨åŠ›å­¦æ–¹ç¨‹

        è¿”å›ï¼š
            dSOC/dt, dTb/dt
        """

        # ===== æ¸©åº¦åŠ¨åŠ›å­¦ =====
        # C_th * dTb/dt = Î·_heat * P - h * (Tb - T_amb)
        dTb_dt = (
            self.eta_heat * P_tot
            - self.h * (Tb - T_amb)
        ) / self.C_th

        # ===== SOC åŠ¨åŠ›å­¦ =====
        # dSOC/dt = - P / E_eff
        E_eff = self.effective_energy(Tb)

        if E_eff > 0:
            dSOC_dt = - P_tot / E_eff
        else:
            dSOC_dt = 0.0

        return dSOC_dt, dTb_dt


    # =====================================================
    # æ—¶é—´æ¨è¿›æ¥å£ï¼ˆEuler / RK4ï¼‰
    # =====================================================

    def step(self, P_tot, T_amb, dt, method="euler"):
        """
        ç”µæ± çŠ¶æ€æ¨è¿› dt ç§’

        å‚æ•°ï¼š
            P_tot : å½“å‰æ€»åŠŸè€—ï¼ˆWï¼‰
            T_amb : ç¯å¢ƒæ¸©åº¦ï¼ˆKï¼‰
            dt    : æ—¶é—´æ­¥é•¿ï¼ˆsï¼‰
            method:
                "euler" â€”â€” æ˜¾å¼æ¬§æ‹‰
                "rk4"   â€”â€” å››é˜¶ Rungeâ€“Kutta
        """

        if method == "euler":
            self._step_euler(P_tot, T_amb, dt)

        elif method == "rk4":
            self._step_rk4(P_tot, T_amb, dt)

        else:
            raise ValueError("method å¿…é¡»ä¸º 'euler' æˆ– 'rk4'")

        # æ•°å€¼ç¨³å®šæ€§ä¿æŠ¤ï¼šSOC é™åˆ¶åœ¨ [0,1]
        self.SOC = max(0.0, min(1.0, self.SOC))


    # -----------------------------------------------------
    # æ˜¾å¼ Euler æ³•ï¼ˆä¸€é˜¶ï¼‰
    # -----------------------------------------------------

    def _step_euler(self, P_tot, T_amb, dt):
        """
        æ˜¾å¼æ¬§æ‹‰ç§¯åˆ†
        """

        dSOC, dTb = self._derivatives(self.SOC, self.Tb, P_tot, T_amb)

        self.SOC += dSOC * dt
        self.Tb += dTb * dt


    # -----------------------------------------------------
    # å››é˜¶ Rungeâ€“Kutta
    # -----------------------------------------------------

    def _step_rk4(self, P_tot, T_amb, dt):
        """
        å››é˜¶ Rungeâ€“Kutta æ—¶é—´ç§¯åˆ†
        """

        SOC0 = self.SOC
        Tb0 = self.Tb

        k1_SOC, k1_Tb = self._derivatives(SOC0, Tb0, P_tot, T_amb)

        k2_SOC, k2_Tb = self._derivatives(
            SOC0 + 0.5 * dt * k1_SOC,
            Tb0 + 0.5 * dt * k1_Tb,
            P_tot,
            T_amb,
        )

        k3_SOC, k3_Tb = self._derivatives(
            SOC0 + 0.5 * dt * k2_SOC,
            Tb0 + 0.5 * dt * k2_Tb,
            P_tot,
            T_amb,
        )

        k4_SOC, k4_Tb = self._derivatives(
            SOC0 + dt * k3_SOC,
            Tb0 + dt * k3_Tb,
            P_tot,
            T_amb,
        )

        self.SOC += dt / 6.0 * (k1_SOC + 2*k2_SOC + 2*k3_SOC + k4_SOC)
        self.Tb += dt / 6.0 * (k1_Tb + 2*k2_Tb + 2*k3_Tb + k4_Tb)


==== src\main.py ====

#!/usr/bin/env python3
# main.py
# å®éªŒä¸»å…¥å£
#
# æä¾›ç»Ÿä¸€çš„å‘½ä»¤è¡Œæ¥å£ï¼Œæ”¯æŒè¿è¡Œä¸åŒç±»å‹çš„å®éªŒï¼š
# - åŸºç¡€ä»¿çœŸ
# - Monte Carlo ä»¿çœŸ
# - æ•æ„Ÿåº¦åˆ†æ
# - åœºæ™¯å¯¹æ¯”

import sys
import os
import argparse

# ç¡®ä¿ src ç›®å½•åœ¨è·¯å¾„ä¸­
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

from experiments import (
    run_basic_experiment,
    run_monte_carlo_experiment,
    run_sensitivity_experiment,
    run_comparison_experiment,
)
from experiments.exp_monte_carlo import run_convergence_analysis
from experiments.exp_sensitivity import run_multi_eps_sensitivity
from experiments.exp_compare import run_sensitivity_to_temperature, run_all_group_comparisons

from usage.scenario import *


# =====================================================
# åœºæ™¯æ˜ å°„
# =====================================================

SCENARIO_MAP = {
    "student_daily": (SCENARIO_STUDENT_DAILY_MIXED, "å­¦ç”Ÿæ—¥å¸¸ (Mixed)"),
    "student_markov": (SCENARIO_STUDENT_DAILY_MARKOV, "å­¦ç”Ÿæ—¥å¸¸ (Markov)"),
    "commute": (SCENARIO_COMMUTE_MIXED, "é€šå‹¤"),
    "weekend": (SCENARIO_WEEKEND_MIXED, "å‘¨æœ«å¨±ä¹"),
    "travel": (SCENARIO_TRAVEL_MIXED, "æ—…è¡Œ"),
    "deepidle": (PURE_DEEPIDLE, "çº¯å¾…æœº"),
    "social": (PURE_SOCIAL, "çº¯ç¤¾äº¤"),
    "video": (PURE_VIDEO, "çº¯è§†é¢‘"),
    "gaming": (PURE_GAMING, "çº¯æ¸¸æˆ"),
    "navigation": (PURE_NAVIGATION, "çº¯å¯¼èˆª"),
}


def print_banner():
    """æ‰“å°æ¬¢è¿æ¨ªå¹…"""
    banner = """
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘                                                              â•‘
    â•‘   ğŸ”‹  æ‰‹æœºç”µæ± ä»¿çœŸç³»ç»Ÿ - Battery Simulation Framework  ğŸ”‹   â•‘
    â•‘                                                              â•‘
    â•‘   æ”¯æŒåŠŸèƒ½:                                                  â•‘
    â•‘   â€¢ åŸºç¡€å•æ¬¡ä»¿çœŸ (basic)                                     â•‘
    â•‘   â€¢ Monte Carlo éšæœºä»¿çœŸ (monte_carlo)                       â•‘
    â•‘   â€¢ å‚æ•°æ•æ„Ÿåº¦åˆ†æ (sensitivity)                             â•‘
    â•‘   â€¢ å¤šåœºæ™¯å¯¹æ¯”åˆ†æ (compare)                                 â•‘
    â•‘                                                              â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    """
    print(banner)


def run_basic(args):
    """è¿è¡ŒåŸºç¡€ä»¿çœŸ"""
    scenario, scenario_name = SCENARIO_MAP.get(args.scenario, (SCENARIO_STUDENT_DAILY_MIXED, "å­¦ç”Ÿæ—¥å¸¸"))
    
    run_basic_experiment(
        scenario=scenario,
        scenario_name=scenario_name,
        seed=args.seed,
        dt=args.dt,
        T_amb=args.temperature + 273.15,
        verbose=True,
        visualize=not args.no_plot,
        dashboard=args.dashboard,
        save_prefix=args.save,
    )


def run_monte_carlo(args):
    """è¿è¡Œ Monte Carlo ä»¿çœŸ"""
    scenario, scenario_name = SCENARIO_MAP.get(args.scenario, (SCENARIO_STUDENT_DAILY_MIXED, "å­¦ç”Ÿæ—¥å¸¸"))
    
    run_monte_carlo_experiment(
        scenario=scenario,
        scenario_name=scenario_name,
        n_samples=args.samples,
        base_seed=args.seed,
        dt=args.dt,
        T_amb=args.temperature + 273.15,
        verbose=True,
        visualize=not args.no_plot,
        summary_plot=args.summary,
        save_prefix=args.save,
    )
    
    if args.convergence:
        print("\nè¿›è¡Œæ”¶æ•›æ€§åˆ†æ...")
        run_convergence_analysis(
            scenario=scenario,
            scenario_name=scenario_name,
            max_samples=args.samples,
            base_seed=args.seed,
            verbose=True,
            visualize=not args.no_plot,
        )


def run_sensitivity(args):
    """è¿è¡Œæ•æ„Ÿåº¦åˆ†æ"""
    scenario, scenario_name = SCENARIO_MAP.get(args.scenario, (SCENARIO_STUDENT_DAILY_MARKOV, "å­¦ç”Ÿæ—¥å¸¸ Markov"))
    
    run_sensitivity_experiment(
        scenario=scenario,
        scenario_name=scenario_name,
        eps=args.eps,
        n_mc=args.samples,
        verbose=True,
        visualize=not args.no_plot,
        comprehensive_plot=args.comprehensive,
        save_prefix=args.save,
    )
    
    if args.multi_eps:
        print("\nè¿›è¡Œå¤šæ‰°åŠ¨å¹…åº¦åˆ†æ...")
        run_multi_eps_sensitivity(
            scenario=scenario,
            scenario_name=scenario_name,
            n_mc=args.samples // 2,
            verbose=True,
            visualize=not args.no_plot,
        )


def run_compare(args):
    """è¿è¡Œåœºæ™¯å¯¹æ¯”"""
    run_comparison_experiment(
        group_name=args.group,
        n_mc=args.samples,
        base_seed=args.seed,
        dt=args.dt,
        T_amb=args.temperature + 273.15,
        verbose=True,
        visualize=not args.no_plot,
        comprehensive_plot=args.comprehensive,
        include_timeline=args.timeline,
        save_prefix=args.save,
    )
    
    if args.temperature_analysis:
        print("\nè¿›è¡Œæ¸©åº¦æ•æ„Ÿæ€§åˆ†æ...")
        scenario, scenario_name = SCENARIO_MAP.get("student_daily", (SCENARIO_STUDENT_DAILY_MIXED, "å­¦ç”Ÿæ—¥å¸¸"))
        run_sensitivity_to_temperature(
            scenario=scenario,
            scenario_name=scenario_name,
            n_mc=args.samples // 2,
            verbose=True,
            visualize=not args.no_plot,
        )


def run_demo(args):
    """è¿è¡Œå¿«é€Ÿæ¼”ç¤º"""
    print_banner()
    
    if args.demo_type == "all" or args.demo_type == "basic":
        print("\n" + "=" * 60)
        print("ğŸ“± åŸºç¡€ä»¿çœŸæ¼”ç¤º")
        print("=" * 60)
        run_basic_experiment(
            scenario=SCENARIO_STUDENT_DAILY_MIXED,
            scenario_name="å­¦ç”Ÿæ—¥å¸¸",
            seed=42,
            visualize=True,
            dashboard=True,
        )
    
    if args.demo_type == "all" or args.demo_type == "monte_carlo":
        print("\n" + "=" * 60)
        print("ğŸ² Monte Carlo ä»¿çœŸæ¼”ç¤º")
        print("=" * 60)
        run_monte_carlo_experiment(
            scenario=SCENARIO_STUDENT_DAILY_MIXED,
            scenario_name="å­¦ç”Ÿæ—¥å¸¸",
            n_samples=100,
            visualize=True,
            summary_plot=True,
        )
    
    if args.demo_type == "all" or args.demo_type == "sensitivity":
        print("\n" + "=" * 60)
        print("ğŸ“Š æ•æ„Ÿåº¦åˆ†ææ¼”ç¤º")
        print("=" * 60)
        run_sensitivity_experiment(
            scenario=SCENARIO_STUDENT_DAILY_MARKOV,
            scenario_name="å­¦ç”Ÿæ—¥å¸¸ Markov",
            n_mc=30,
            visualize=True,
            comprehensive_plot=True,
        )
    
    if args.demo_type == "all" or args.demo_type == "compare":
        print("\n" + "=" * 60)
        print("ğŸ”¬ åœºæ™¯å¯¹æ¯”æ¼”ç¤º")
        print("=" * 60)
        run_comparison_experiment(
            group_name="æ—¥å¸¸åœºæ™¯",
            n_mc=30,
            visualize=True,
            comprehensive_plot=True,
            include_timeline=True,
        )


def main():
    """ä¸»å‡½æ•°"""
    parser = argparse.ArgumentParser(
        description="æ‰‹æœºç”µæ± ä»¿çœŸç³»ç»Ÿ - Battery Simulation Framework",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
ç¤ºä¾‹ç”¨æ³•:
  # è¿è¡ŒåŸºç¡€ä»¿çœŸ
  python main.py basic --scenario student_daily --seed 42 --dashboard
  
  # è¿è¡Œ Monte Carlo ä»¿çœŸ
  python main.py monte_carlo --scenario gaming --samples 200 --summary
  
  # è¿è¡Œæ•æ„Ÿåº¦åˆ†æ
  python main.py sensitivity --scenario student_markov --eps 0.2 --comprehensive
  
  # è¿è¡Œåœºæ™¯å¯¹æ¯”
  python main.py compare --group æ—¥å¸¸åœºæ™¯ --timeline --comprehensive
  
  # è¿è¡Œå¿«é€Ÿæ¼”ç¤º
  python main.py demo --type all
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="å®éªŒç±»å‹")
    
    # ===== åŸºç¡€ä»¿çœŸ =====
    parser_basic = subparsers.add_parser("basic", help="åŸºç¡€å•æ¬¡ä»¿çœŸ")
    parser_basic.add_argument("--scenario", type=str, default="student_daily",
                              choices=list(SCENARIO_MAP.keys()),
                              help="ä½¿ç”¨åœºæ™¯")
    parser_basic.add_argument("--seed", type=int, default=42, help="éšæœºç§å­")
    parser_basic.add_argument("--dt", type=float, default=1.0, help="æ—¶é—´æ­¥é•¿ï¼ˆç§’ï¼‰")
    parser_basic.add_argument("--temperature", type=float, default=25.0, help="ç¯å¢ƒæ¸©åº¦ï¼ˆÂ°Cï¼‰")
    parser_basic.add_argument("--dashboard", action="store_true", help="æ˜¾ç¤ºç»¼åˆä»ªè¡¨æ¿")
    parser_basic.add_argument("--no-plot", action="store_true", help="ä¸æ˜¾ç¤ºå›¾å½¢")
    parser_basic.add_argument("--save", type=str, default=None, help="ä¿å­˜å›¾ç‰‡è·¯å¾„å‰ç¼€")
    parser_basic.set_defaults(func=run_basic)
    
    # ===== Monte Carlo ä»¿çœŸ =====
    parser_mc = subparsers.add_parser("monte_carlo", help="Monte Carlo éšæœºä»¿çœŸ")
    parser_mc.add_argument("--scenario", type=str, default="student_daily",
                           choices=list(SCENARIO_MAP.keys()),
                           help="ä½¿ç”¨åœºæ™¯")
    parser_mc.add_argument("--samples", type=int, default=100, help="ä»¿çœŸæ¬¡æ•°")
    parser_mc.add_argument("--seed", type=int, default=0, help="åŸºç¡€éšæœºç§å­")
    parser_mc.add_argument("--dt", type=float, default=1.0, help="æ—¶é—´æ­¥é•¿ï¼ˆç§’ï¼‰")
    parser_mc.add_argument("--temperature", type=float, default=25.0, help="ç¯å¢ƒæ¸©åº¦ï¼ˆÂ°Cï¼‰")
    parser_mc.add_argument("--summary", action="store_true", help="æ˜¾ç¤ºç»¼åˆç»Ÿè®¡å›¾")
    parser_mc.add_argument("--convergence", action="store_true", help="è¿›è¡Œæ”¶æ•›æ€§åˆ†æ")
    parser_mc.add_argument("--no-plot", action="store_true", help="ä¸æ˜¾ç¤ºå›¾å½¢")
    parser_mc.add_argument("--save", type=str, default=None, help="ä¿å­˜å›¾ç‰‡è·¯å¾„å‰ç¼€")
    parser_mc.set_defaults(func=run_monte_carlo)
    
    # ===== æ•æ„Ÿåº¦åˆ†æ =====
    parser_sens = subparsers.add_parser("sensitivity", help="å‚æ•°æ•æ„Ÿåº¦åˆ†æ")
    parser_sens.add_argument("--scenario", type=str, default="student_markov",
                             choices=list(SCENARIO_MAP.keys()),
                             help="ä½¿ç”¨åœºæ™¯")
    parser_sens.add_argument("--eps", type=float, default=0.2, help="æ‰°åŠ¨å¹…åº¦")
    parser_sens.add_argument("--samples", type=int, default=50, help="Monte Carlo æ ·æœ¬æ•°")
    parser_sens.add_argument("--comprehensive", action="store_true", help="æ˜¾ç¤ºç»¼åˆåˆ†æå›¾")
    parser_sens.add_argument("--multi-eps", action="store_true", help="è¿›è¡Œå¤šæ‰°åŠ¨å¹…åº¦åˆ†æ")
    parser_sens.add_argument("--no-plot", action="store_true", help="ä¸æ˜¾ç¤ºå›¾å½¢")
    parser_sens.add_argument("--save", type=str, default=None, help="ä¿å­˜å›¾ç‰‡è·¯å¾„å‰ç¼€")
    parser_sens.set_defaults(func=run_sensitivity)
    
    # ===== åœºæ™¯å¯¹æ¯” =====
    parser_compare = subparsers.add_parser("compare", help="å¤šåœºæ™¯å¯¹æ¯”åˆ†æ")
    parser_compare.add_argument("--group", type=str, default="æ—¥å¸¸åœºæ™¯",
                                choices=["æ—¥å¸¸åœºæ™¯", "æç«¯åœºæ™¯", "æ··åˆ vs Markov"],
                                help="åœºæ™¯ç»„")
    parser_compare.add_argument("--samples", type=int, default=50, help="Monte Carlo æ ·æœ¬æ•°")
    parser_compare.add_argument("--seed", type=int, default=0, help="åŸºç¡€éšæœºç§å­")
    parser_compare.add_argument("--dt", type=float, default=1.0, help="æ—¶é—´æ­¥é•¿ï¼ˆç§’ï¼‰")
    parser_compare.add_argument("--temperature", type=float, default=25.0, help="ç¯å¢ƒæ¸©åº¦ï¼ˆÂ°Cï¼‰")
    parser_compare.add_argument("--comprehensive", action="store_true", help="æ˜¾ç¤ºç»¼åˆåˆ†æå›¾")
    parser_compare.add_argument("--timeline", action="store_true", help="åŒ…å«æ—¶é—´çº¿å¯¹æ¯”")
    parser_compare.add_argument("--temperature-analysis", action="store_true", help="è¿›è¡Œæ¸©åº¦æ•æ„Ÿæ€§åˆ†æ")
    parser_compare.add_argument("--no-plot", action="store_true", help="ä¸æ˜¾ç¤ºå›¾å½¢")
    parser_compare.add_argument("--save", type=str, default=None, help="ä¿å­˜å›¾ç‰‡è·¯å¾„å‰ç¼€")
    parser_compare.set_defaults(func=run_compare)
    
    # ===== å¿«é€Ÿæ¼”ç¤º =====
    parser_demo = subparsers.add_parser("demo", help="å¿«é€Ÿæ¼”ç¤º")
    parser_demo.add_argument("--type", type=str, dest="demo_type", default="all",
                             choices=["all", "basic", "monte_carlo", "sensitivity", "compare"],
                             help="æ¼”ç¤ºç±»å‹")
    parser_demo.set_defaults(func=run_demo)
    
    args = parser.parse_args()
    
    if args.command is None:
        print_banner()
        parser.print_help()
        return
    
    print_banner()
    args.func(args)


if __name__ == "__main__":
    main()


==== src\power_model.py ====

# power_model.py
# æ ¹æ®â€œä½¿ç”¨çŠ¶æ€ç»™å®šçš„ä¸€ç»„å‚æ•°â€ï¼Œè®¡ç®—ç¬æ—¶åŠŸè€— P(t)


# =========================
# å±å¹•åŠŸè€—æ¨¡å‹
# =========================
def screen_power(p):
    """
    AMOLED å±å¹•åŠŸè€—æ¨¡å‹
    å‚æ•° p ä¸­åº”åŒ…å«ï¼š
        s       : æ˜¯å¦äº®å±ï¼ˆ0/1ï¼‰
        u       : å¹³å‡å½’ä¸€åŒ–äº®åº¦ï¼ˆ0~1ï¼‰
        r       : åˆ·æ–°ç‡ï¼ˆHzï¼‰
        A       : å±å¹•å‘å…‰é¢ç§¯ï¼ˆcm^2ï¼‰
        p_u     : å•ä½é¢ç§¯å•ä½äº®åº¦åŠŸè€—å¯†åº¦ï¼ˆW/cm^2ï¼‰
        P_base60: 60Hz äº®å±åŸºçº¿åŠŸè€—ï¼ˆWï¼‰
        kappa   : åˆ·æ–°ç‡æ•æ„Ÿç³»æ•°
        P_off   : æ¯å±åŸºçº¿åŠŸè€—ï¼ˆWï¼‰
    """
    if p["s"] == 0:
        return p["P_off"]

    P_base = p["P_base60"] * (1 + p["kappa"] * (p["r"] / 60.0 - 1))
    P_emit = p["A"] * p["p_u"] * p["u"]

    return P_base + P_emit


# =========================
# CPU åŠŸè€—æ¨¡å‹
# =========================
def cpu_power(p):
    """
    CPU åŠŸè€—æ¨¡å‹
    å‚æ•°ï¼š
        u_cpu  : CPU åˆ©ç”¨ç‡ï¼ˆ0~1ï¼‰
        P_idle : ç©ºè½½åŠŸè€—ï¼ˆWï¼‰
        P_dyn  : æ»¡è´Ÿè½½åŠ¨æ€åŠŸè€—å¢é‡ï¼ˆWï¼‰
    """
    return p["P_idle"] + p["P_dyn"] * p["u_cpu"]


# =========================
# æ— çº¿é€šä¿¡åŠŸè€—æ¨¡å‹
# =========================
def radio_power(p):
    """
    æ— çº¿é€šä¿¡åŠŸè€—æ¨¡å‹ï¼ˆä¸‰æ€ + åˆ¶å¼ + ä¿¡å·ä¿®æ­£ï¼‰
    å‚æ•°ï¼š
        R_i, R_a, R_t : Idle / Active / Tail æ—¶é—´æ¯”ä¾‹
        P_i, P_a, P_t : å„çŠ¶æ€åŠŸè€—
        lambda_cell  : èœ‚çªç½‘ç»œä½¿ç”¨æ¯”ä¾‹
        alpha_cell   : èœ‚çªåŠŸè€—ç³»æ•°
        alpha_wifi   : WiFi åŠŸè€—ç³»æ•°
        delta_signal : ä¿¡å·è´¨é‡ä¿®æ­£
    """
    P_avg = (
        p["R_i"] * p["P_i"]
        + p["R_a"] * p["P_a"]
        + p["R_t"] * p["P_t"]
    )

    alpha = (
        p["lambda_cell"] * p["alpha_cell"]
        + (1 - p["lambda_cell"]) * p["alpha_wifi"]
    )

    return P_avg * alpha * (1 + p["delta_signal"])


# =========================
# GPS åŠŸè€—æ¨¡å‹
# =========================
def gps_power(p):
    """
    GPS åŠŸè€—æ¨¡å‹ï¼ˆå¯ç”¨æ¯”ä¾‹æ¨¡å‹ï¼‰
    å‚æ•°ï¼š
        r_on : GPS å¯ç”¨æ—¶é—´æ¯”ä¾‹ï¼ˆ0~1ï¼‰
        P_on : æŒç»­å®šä½åŠŸè€—ï¼ˆWï¼‰
    """
    return p["r_on"] * p["P_on"]


# =========================
# åå°åŠŸè€—æ¨¡å‹
# =========================
def background_power(p):
    """
    åå°åŠŸè€—æ¨¡å‹ï¼ˆIdle / Active æ¯”ä¾‹ï¼‰
    å‚æ•°ï¼š
        r_bg     : åå°æ´»è·ƒæ—¶é—´æ¯”ä¾‹
        P_bg_idle: åå°ç©ºé—²åŠŸè€—
        P_bg_act : åå°æ´»è·ƒåŠŸè€—
    """
    return (
        p["r_bg"] * p["P_bg_act"]
        + (1 - p["r_bg"]) * p["P_bg_idle"]
    )


# =========================
# ç¬æ—¶æ€»åŠŸè€—
# =========================
def total_power(state_params):
    """
    ç¬æ—¶æ€»åŠŸè€—
    æ‰€æœ‰å­æ¨¡å—åŠŸè€—çš„ä»£æ•°å’Œ
    """
    return (
        screen_power(state_params)
        + cpu_power(state_params)
        + radio_power(state_params)
        + gps_power(state_params)
        + background_power(state_params)
    )


==== src\sensitivity.py ====

# sensitivity.py
#
# Usage å‚æ•°æ•æ„Ÿåº¦åˆ†ææ¨¡å—
#
# åŸºäºæœ‰é™å·®åˆ†ï¼š
#   å¯¹å•ä¸ªå‚æ•° Â±æ‰°åŠ¨
#   è§‚å¯Ÿ TTL å˜åŒ–
#

import copy

from simulate import run_monte_carlo
from usage.state import USAGE_STATES


# =====================================================
# å¯é€‰æ•æ„Ÿå‚æ•°ï¼ˆusage ç›¸å…³ï¼‰
# =====================================================

SENS_PARAMS = [
    "u",            # å±å¹•äº®åº¦
    "r",            # åˆ·æ–°ç‡
    "u_cpu",        # CPU åˆ©ç”¨ç‡
    "lambda_cell",  # èœ‚çªæ¯”ä¾‹
    "delta_signal", # ä¿¡å·è´¨é‡
    "r_on",         # GPS å¼€å¯æ¯”ä¾‹
]


def perturb_usage(param, factor):
    """
    å¯¹æ‰€æœ‰ usage çŠ¶æ€çš„æŸä¸ªå‚æ•°è¿›è¡Œæ¯”ä¾‹æ‰°åŠ¨
    """

    for state in USAGE_STATES.values():
        if param in state:
            state[param] *= factor


def sensitivity_analysis(
    scenario,
    param_list=SENS_PARAMS,
    eps=0.2,
    n_mc=100,
):
    """
    å‚æ•°æ•æ„Ÿåº¦åˆ†æ

    eps : æ‰°åŠ¨æ¯”ä¾‹ï¼ˆé»˜è®¤ Â±10%ï¼‰
    """

    # ä¿å­˜åŸå§‹ usage å‚æ•°
    original_states = copy.deepcopy(USAGE_STATES)

    print("\n===== Baseline =====")
    ttl_base = sum(run_monte_carlo(scenario, n_samples=n_mc)) / n_mc

    results = {}

    for p in param_list:

        print(f"\n--- å‚æ•°: {p} ---")

        # æ­£æ‰°åŠ¨
        perturb_usage(p, 1 + eps)
        ttl_plus = sum(run_monte_carlo(scenario, n_samples=n_mc)) / n_mc

        # æ¢å¤
        USAGE_STATES.clear()
        USAGE_STATES.update(copy.deepcopy(original_states))

        # è´Ÿæ‰°åŠ¨
        perturb_usage(p, 1 - eps)
        ttl_minus = sum(run_monte_carlo(scenario, n_samples=n_mc)) / n_mc

        # æ¢å¤
        USAGE_STATES.clear()
        USAGE_STATES.update(copy.deepcopy(original_states))

        # ä¸­å¿ƒå·®åˆ†æ•æ„Ÿåº¦
        S = (ttl_plus - ttl_minus) / (2 * eps)

        # å½’ä¸€åŒ–æ•æ„Ÿåº¦
        S_norm = S / ttl_base

        results[p] = {
            "TTL+": ttl_plus,
            "TTL-": ttl_minus,
            "S": S,
            "S_norm": S_norm,
        }

        print(f"TTL+ = {ttl_plus/3600:.2f} h")
        print(f"TTL- = {ttl_minus/3600:.2f} h")
        print(f"S_norm = {S_norm:.3f}")

    return results

if __name__ == "__main__":
    from usage.scenario import *

    res = sensitivity_analysis(
        SCENARIO_STUDENT_DAILY_MARKOV,
        n_mc=100,
    )

==== src\simulate.py ====

# simulate.py
#
# æ ¸å¿ƒä»¿çœŸæ¨¡å—ï¼ˆæ— å¯è§†åŒ–ï¼‰
#
# usage â†’ power â†’ battery
# æ”¯æŒï¼š
#   - éšæœºç§å­æ§åˆ¶ï¼ˆå¯å¤ç°ï¼‰
#   - æ—¶é—´åºåˆ—è®°å½•
#   - Monte Carlo ä»¿çœŸ

import random

from battery_model import BatteryModel
from power_model import total_power
from usage.state import get_state_params
from usage.control import ScenarioController

from usage.scenario import *

# =====================================================
# å•æ¬¡ä»¿çœŸ
# =====================================================
def run_simulation(
    scenario=SCENARIO_STUDENT_DAILY_MIXED,
    dt=1.0,
    T_amb=298.15,
    seed=None,
    record=True,
):
    """
    å•æ¬¡è¿è¡Œä»¿çœŸç›´åˆ°ç”µæ± è€—å°½

    Returns
    -------
    result : dict
        {
          "TTL": float,
          "time": [...],
          "SOC": [...],
          "Tb": [...],
          "Power": [...],
          "State": [...]
        }
    """

    # ---------- éšæœºç§å­ ----------
    if seed is not None:
        random.seed(seed)

    # ---------- åˆå§‹åŒ–ç”µæ±  ----------
    battery = BatteryModel(
        SOC0=1.0,
        Tb0=298.15,
        aging_loss=0.15,
    )

    # ---------- ä½¿ç”¨è¡Œä¸ºæ§åˆ¶å™¨ ----------
    controller = ScenarioController(scenario)

    # ---------- è®°å½• ----------
    time_list = []
    soc_list = []
    tb_list = []
    power_list = []
    state_list = []

    t = 0.0

    # ---------- ä¸»å¾ªç¯ ----------
    while battery.SOC > 0:

        current_state = controller.step(dt)
        state_params = get_state_params(current_state)
        P = total_power(state_params)

        battery.step(P, T_amb, dt)

        if record:
            time_list.append(t)
            soc_list.append(battery.SOC)
            tb_list.append(battery.Tb)
            power_list.append(P)
            state_list.append(current_state)

        t += dt

    result = {
        "TTL": t,
    }

    if record:
        result.update({
            "time": time_list,
            "SOC": soc_list,
            "Tb": tb_list,
            "Power": power_list,
            "State": state_list,
        })

    return result


# =====================================================
# Monte Carlo ä»¿çœŸ
# =====================================================
def run_monte_carlo(
    scenario,
    n_samples=100,
    base_seed=0,
    dt=1.0,
    T_amb=298.15,
):
    """
    Monte Carlo å¤šæ¬¡éšæœºä»¿çœŸ
    """

    ttl_list = []

    for i in range(n_samples):
        result = run_simulation(
            scenario=scenario,
            dt=dt,
            T_amb=T_amb,
            seed=base_seed + i,
            record=False,
        )
        ttl_list.append(result["TTL"])

    return ttl_list


# =====================================================
# ç¤ºä¾‹ï¼ˆä»…æµ‹è¯•æ ¸å¿ƒä»¿çœŸåŠŸèƒ½ï¼‰
# =====================================================
if __name__ == "__main__":

    # ---------- å•æ¬¡å¯å¤ç°ä»¿çœŸ ----------
    result = run_simulation(
        PURE_GAMING,
        seed=42,
        record=True,
    )
    print(f"TTL = {result['TTL'] / 3600:.2f} hours")

    # ---------- Monte Carlo ----------
    ttl_mc = run_monte_carlo(
        PURE_GAMING,
        n_samples=100,
        base_seed=1000,
    )
    
    import numpy as np
    print(f"Monte Carlo TTL: mean={np.mean(ttl_mc)/3600:.2f}h, std={np.std(ttl_mc)/3600:.3f}h")
