**[experiments]**

==== src/experiments\exp_basic.py ====

# experiments/exp_basic.py
# åŸºç¡€å•æ¬¡ä»¿çœŸå®éªŒæ¨¡å—
#
# æä¾›å•æ¬¡ä»¿çœŸå®éªŒåŠŸèƒ½ï¼š
# - è¿è¡Œå•æ¬¡ä»¿çœŸ
# - è¾“å‡ºç»“æœæ‘˜è¦
# - å¯è§†åŒ–ä»¿çœŸè¿‡ç¨‹

import sys
import os

# æ·»åŠ  src ç›®å½•åˆ°è·¯å¾„
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from simulate import run_simulation
from visualization import (
    plot_single_run,
    plot_comprehensive_dashboard,
    plot_soc_curve,
    plot_power_curve,
    plot_temperature_curve,
    plot_state_timeline,
)
from usage.scenario import *


def run_basic_experiment(
    scenario=None,
    scenario_name="é»˜è®¤åœºæ™¯",
    seed=42,
    dt=1.0,
    T_amb=298.15,
    verbose=True,
    visualize=True,
    dashboard=False,
    save_prefix=None,
):
    """
    è¿è¡ŒåŸºç¡€å•æ¬¡ä»¿çœŸå®éªŒ
    
    å‚æ•°ï¼š
        scenario : dict - ä½¿ç”¨åœºæ™¯é…ç½®
        scenario_name : str - åœºæ™¯åç§°
        seed : int - éšæœºç§å­
        dt : float - æ—¶é—´æ­¥é•¿ï¼ˆç§’ï¼‰
        T_amb : float - ç¯å¢ƒæ¸©åº¦ï¼ˆKï¼‰
        verbose : bool - æ˜¯å¦è¾“å‡ºè¯¦ç»†ä¿¡æ¯
        visualize : bool - æ˜¯å¦å¯è§†åŒ–ç»“æœ
        dashboard : bool - æ˜¯å¦æ˜¾ç¤ºç»¼åˆä»ªè¡¨æ¿
        save_prefix : str - å›¾ç‰‡ä¿å­˜è·¯å¾„å‰ç¼€
    
    è¿”å›ï¼š
        result : dict - ä»¿çœŸç»“æœ
    """
    
    # é»˜è®¤åœºæ™¯
    if scenario is None:
        scenario = SCENARIO_STUDENT_DAILY_MIXED
        scenario_name = "å­¦ç”Ÿæ—¥å¸¸æ··åˆåœºæ™¯"
    
    if verbose:
        print("=" * 60)
        print("ğŸ”‹ åŸºç¡€ä»¿çœŸå®éªŒ")
        print("=" * 60)
        print(f"åœºæ™¯: {scenario_name}")
        print(f"éšæœºç§å­: {seed}")
        print(f"æ—¶é—´æ­¥é•¿: {dt} ç§’")
        print(f"ç¯å¢ƒæ¸©åº¦: {T_amb - 273.15:.1f} Â°C")
        print("-" * 60)
        print("æ­£åœ¨è¿è¡Œä»¿çœŸ...")
    
    # è¿è¡Œä»¿çœŸ
    result = run_simulation(
        scenario=scenario,
        dt=dt,
        T_amb=T_amb,
        seed=seed,
        record=True,
    )
    
    # è¾“å‡ºç»“æœæ‘˜è¦
    ttl_hours = result["TTL"] / 3600
    
    if verbose:
        print("-" * 60)
        print("âœ… ä»¿çœŸå®Œæˆï¼")
        print("-" * 60)
        print(f"ğŸ“Š ç»“æœæ‘˜è¦:")
        print(f"   ç»­èˆªæ—¶é—´ (TTL): {ttl_hours:.2f} å°æ—¶")
        
        if "Power" in result:
            import numpy as np
            avg_power = np.mean(result["Power"])
            max_power = np.max(result["Power"])
            print(f"   å¹³å‡åŠŸè€—: {avg_power:.3f} W")
            print(f"   æœ€å¤§åŠŸè€—: {max_power:.3f} W")
        
        if "Tb" in result:
            max_temp = max(result["Tb"]) - 273.15
            print(f"   æœ€é«˜æ¸©åº¦: {max_temp:.1f} Â°C")
        
        if "State" in result:
            from collections import Counter
            state_counts = Counter(result["State"])
            total = sum(state_counts.values())
            print(f"   çŠ¶æ€åˆ†å¸ƒ:")
            for state, count in sorted(state_counts.items(), key=lambda x: -x[1]):
                print(f"     - {state}: {count/total*100:.1f}%")
        
        print("=" * 60)
    
    # å¯è§†åŒ–
    if visualize:
        if dashboard:
            # ç»¼åˆä»ªè¡¨æ¿
            save_path = f"{save_prefix}_dashboard.png" if save_prefix else None
            plot_comprehensive_dashboard(result, save_path=save_path, T_amb=T_amb)
        else:
            # ç®€å•å›¾è¡¨
            save_path = f"{save_prefix}_basic.png" if save_prefix else None
            plot_single_run(result, save_path=save_path)
    
    return result


def run_quick_demo():
    """
    å¿«é€Ÿæ¼”ç¤ºåŸºç¡€ä»¿çœŸ
    """
    print("\n" + "ğŸš€ å¿«é€Ÿæ¼”ç¤ºï¼šåŸºç¡€ä»¿çœŸ\n")
    
    # æµ‹è¯•å‡ ä¸ªä¸åŒåœºæ™¯
    scenarios = [
        (SCENARIO_STUDENT_DAILY_MIXED, "å­¦ç”Ÿæ—¥å¸¸ (Mixed)"),
        (PURE_GAMING, "çº¯æ¸¸æˆ"),
        (PURE_VIDEO, "çº¯è§†é¢‘"),
    ]
    
    for scenario, name in scenarios:
        result = run_basic_experiment(
            scenario=scenario,
            scenario_name=name,
            seed=42,
            visualize=False,
            verbose=True,
        )
    
    # æœ€åä¸€ä¸ªæ˜¾ç¤ºå¯è§†åŒ–
    print("\næ˜¾ç¤ºæœ€åä¸€ä¸ªåœºæ™¯çš„å¯è§†åŒ–...")
    run_basic_experiment(
        scenario=SCENARIO_STUDENT_DAILY_MIXED,
        scenario_name="å­¦ç”Ÿæ—¥å¸¸",
        seed=42,
        visualize=True,
        dashboard=True,
        verbose=False,
    )


if __name__ == "__main__":
    run_quick_demo()


==== src/experiments\exp_compare.py ====

# experiments/exp_compare.py
# åœºæ™¯å¯¹æ¯”å®éªŒæ¨¡å—
#
# æä¾›åœºæ™¯å¯¹æ¯”å®éªŒåŠŸèƒ½ï¼š
# - å¤šåœºæ™¯ Monte Carlo å¯¹æ¯”
# - ç»Ÿè®¡å¯¹æ¯”åˆ†æ
# - å¯¹æ¯”å¯è§†åŒ–

import sys
import os
import numpy as np

# æ·»åŠ  src ç›®å½•åˆ°è·¯å¾„
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from simulate import run_simulation, run_monte_carlo
from visualization import (
    plot_scenario_comparison,
    plot_scenario_boxplot,
    plot_scenario_radar,
    plot_multi_scenario_timeline,
)
from visualization.comparison import plot_scenario_comprehensive_comparison
from usage.scenario import *


# =====================================================
# é¢„å®šä¹‰åœºæ™¯ç»„åˆ
# =====================================================

SCENARIO_GROUPS = {
    "æ—¥å¸¸åœºæ™¯": {
        "å­¦ç”Ÿæ—¥å¸¸": SCENARIO_STUDENT_DAILY_MIXED,
        "é€šå‹¤": SCENARIO_COMMUTE_MIXED,
        "å‘¨æœ«å¨±ä¹": SCENARIO_WEEKEND_MIXED,
        "æ—…è¡Œ": SCENARIO_TRAVEL_MIXED,
    },
    "æç«¯åœºæ™¯": {
        "çº¯å¾…æœº": PURE_DEEPIDLE,
        "çº¯ç¤¾äº¤": PURE_SOCIAL,
        "çº¯è§†é¢‘": PURE_VIDEO,
        "çº¯æ¸¸æˆ": PURE_GAMING,
        "çº¯å¯¼èˆª": PURE_NAVIGATION,
    },
    "æ··åˆ vs Markov": {
        "å­¦ç”Ÿæ—¥å¸¸ Mixed": SCENARIO_STUDENT_DAILY_MIXED,
        "å­¦ç”Ÿæ—¥å¸¸ Markov": SCENARIO_STUDENT_DAILY_MARKOV,
        "é€šå‹¤ Mixed": SCENARIO_COMMUTE_MIXED,
        "é€šå‹¤ Markov": SCENARIO_COMMUTE_MARKOV,
    },
}


def run_comparison_experiment(
    scenarios=None,
    group_name=None,
    n_mc=100,
    base_seed=0,
    dt=1.0,
    T_amb=298.15,
    verbose=True,
    visualize=True,
    comprehensive_plot=False,
    include_timeline=False,
    save_prefix=None,
):
    """
    è¿è¡Œåœºæ™¯å¯¹æ¯”å®éªŒ
    
    å‚æ•°ï¼š
        scenarios : dict - åœºæ™¯å­—å…¸ {name: scenario_config}
        group_name : str - é¢„å®šä¹‰åœºæ™¯ç»„åç§°
        n_mc : int - Monte Carlo æ ·æœ¬æ•°
        base_seed : int - åŸºç¡€éšæœºç§å­
        dt : float - æ—¶é—´æ­¥é•¿ï¼ˆç§’ï¼‰
        T_amb : float - ç¯å¢ƒæ¸©åº¦ï¼ˆKï¼‰
        verbose : bool - æ˜¯å¦è¾“å‡ºè¯¦ç»†ä¿¡æ¯
        visualize : bool - æ˜¯å¦å¯è§†åŒ–ç»“æœ
        comprehensive_plot : bool - æ˜¯å¦æ˜¾ç¤ºç»¼åˆåˆ†æå›¾
        include_timeline : bool - æ˜¯å¦åŒ…å«æ—¶é—´çº¿å¯¹æ¯”
        save_prefix : str - å›¾ç‰‡ä¿å­˜è·¯å¾„å‰ç¼€
    
    è¿”å›ï¼š
        results : dict - å¯¹æ¯”ç»“æœ
    """
    
    # è·å–åœºæ™¯
    if scenarios is None:
        if group_name is not None and group_name in SCENARIO_GROUPS:
            scenarios = SCENARIO_GROUPS[group_name]
        else:
            scenarios = SCENARIO_GROUPS["æ—¥å¸¸åœºæ™¯"]
            group_name = "æ—¥å¸¸åœºæ™¯"
    
    if group_name is None:
        group_name = "è‡ªå®šä¹‰åœºæ™¯ç»„"
    
    if verbose:
        print("=" * 60)
        print("ğŸ”¬ åœºæ™¯å¯¹æ¯”å®éªŒ")
        print("=" * 60)
        print(f"åœºæ™¯ç»„: {group_name}")
        print(f"åŒ…å«åœºæ™¯: {list(scenarios.keys())}")
        print(f"Monte Carlo æ ·æœ¬æ•°: {n_mc}")
        print(f"ç¯å¢ƒæ¸©åº¦: {T_amb - 273.15:.1f} Â°C")
        print("-" * 60)
    
    results = {}
    single_results = {}  # å•æ¬¡ä»¿çœŸç»“æœï¼ˆç”¨äºæ—¶é—´çº¿ï¼‰
    
    for name, scenario in scenarios.items():
        if verbose:
            print(f"åˆ†æåœºæ™¯: {name}...")
        
        # Monte Carlo ä»¿çœŸ
        ttl_list = run_monte_carlo(
            scenario=scenario,
            n_samples=n_mc,
            base_seed=base_seed,
            dt=dt,
            T_amb=T_amb,
        )
        
        # è®¡ç®—ç»Ÿè®¡é‡
        results[name] = {
            "ttl_list": ttl_list,
            "mean": np.mean(ttl_list),
            "std": np.std(ttl_list),
            "min": np.min(ttl_list),
            "max": np.max(ttl_list),
            "median": np.median(ttl_list),
            "q1": np.percentile(ttl_list, 25),
            "q3": np.percentile(ttl_list, 75),
        }
        
        if verbose:
            print(f"  å‡å€¼: {results[name]['mean']/3600:.2f} h, æ ‡å‡†å·®: {results[name]['std']/3600:.3f} h")
        
        # å•æ¬¡ä»¿çœŸï¼ˆç”¨äºæ—¶é—´çº¿ï¼‰
        if include_timeline:
            single_result = run_simulation(
                scenario=scenario,
                dt=dt,
                T_amb=T_amb,
                seed=base_seed,
                record=True,
            )
            single_results[name] = single_result
    
    if verbose:
        print("-" * 60)
        print("âœ… åœºæ™¯å¯¹æ¯”åˆ†æå®Œæˆï¼")
        print("-" * 60)
        
        # æ’åºè¾“å‡º
        sorted_scenarios = sorted(results.keys(), key=lambda s: results[s]["mean"], reverse=True)
        print("ğŸ“Š ç»­èˆªæ’åï¼ˆç”±é«˜åˆ°ä½ï¼‰:")
        best_ttl = results[sorted_scenarios[0]]["mean"]
        for i, name in enumerate(sorted_scenarios, 1):
            ttl = results[name]["mean"]
            relative = (ttl / best_ttl - 1) * 100
            print(f"  {i}. {name}: {ttl/3600:.2f} h ({relative:+.1f}%)")
        
        print("=" * 60)
    
    # å¯è§†åŒ–
    if visualize:
        if comprehensive_plot:
            # ç»¼åˆåˆ†æå›¾
            save_path = f"{save_prefix}_compare_comprehensive.png" if save_prefix else None
            plot_scenario_comprehensive_comparison(
                results, 
                results_dict=single_results if include_timeline else None,
                save_path=save_path
            )
        else:
            # ç®€å•æŸ±çŠ¶å›¾
            save_path = f"{save_prefix}_compare_bar.png" if save_prefix else None
            plot_scenario_comparison(results, save_path=save_path)
    
    return results


def run_sensitivity_to_temperature(
    scenario=None,
    scenario_name="é»˜è®¤åœºæ™¯",
    T_amb_range=None,
    n_mc=50,
    verbose=True,
    visualize=True,
):
    """
    è¿è¡Œæ¸©åº¦æ•æ„Ÿæ€§åˆ†æ
    
    å‚æ•°ï¼š
        scenario : dict - ä½¿ç”¨åœºæ™¯é…ç½®
        scenario_name : str - åœºæ™¯åç§°
        T_amb_range : list - ç¯å¢ƒæ¸©åº¦èŒƒå›´ï¼ˆKï¼‰
        n_mc : int - Monte Carlo æ ·æœ¬æ•°
        verbose : bool - æ˜¯å¦è¾“å‡ºè¯¦ç»†ä¿¡æ¯
        visualize : bool - æ˜¯å¦å¯è§†åŒ–ç»“æœ
    
    è¿”å›ï¼š
        results : dict - æ¸©åº¦æ•æ„Ÿæ€§ç»“æœ
    """
    import matplotlib.pyplot as plt
    
    if scenario is None:
        scenario = SCENARIO_STUDENT_DAILY_MIXED
        scenario_name = "å­¦ç”Ÿæ—¥å¸¸"
    
    if T_amb_range is None:
        # 0Â°C åˆ° 40Â°C
        T_amb_range = [273.15 + t for t in [0, 10, 20, 25, 30, 35, 40]]
    
    if verbose:
        print("=" * 60)
        print("ğŸŒ¡ï¸ ç¯å¢ƒæ¸©åº¦æ•æ„Ÿæ€§åˆ†æ")
        print("=" * 60)
        print(f"åœºæ™¯: {scenario_name}")
        print(f"æ¸©åº¦èŒƒå›´: {[t-273.15 for t in T_amb_range]} Â°C")
        print("-" * 60)
    
    results = {
        "temperatures": [t - 273.15 for t in T_amb_range],
        "means": [],
        "stds": [],
    }
    
    for T_amb in T_amb_range:
        ttl_list = run_monte_carlo(
            scenario=scenario,
            n_samples=n_mc,
            T_amb=T_amb,
        )
        
        mean_ttl = np.mean(ttl_list) / 3600
        std_ttl = np.std(ttl_list) / 3600
        
        results["means"].append(mean_ttl)
        results["stds"].append(std_ttl)
        
        if verbose:
            print(f"  {T_amb-273.15:5.1f}Â°C: å‡å€¼={mean_ttl:.2f} h, æ ‡å‡†å·®={std_ttl:.3f} h")
    
    if visualize:
        fig, ax = plt.subplots(figsize=(10, 6))
        
        temps = results["temperatures"]
        means = results["means"]
        stds = results["stds"]
        
        ax.plot(temps, means, 'o-', color='#2E86AB', linewidth=2, markersize=8, label='å¹³å‡ TTL')
        ax.fill_between(temps, 
                        [m - s for m, s in zip(means, stds)],
                        [m + s for m, s in zip(means, stds)],
                        alpha=0.3, color='#2E86AB', label='Â±1Ïƒ')
        
        ax.set_xlabel("ç¯å¢ƒæ¸©åº¦ (Â°C)")
        ax.set_ylabel("ç»­èˆªæ—¶é—´ TTL (å°æ—¶)")
        ax.set_title(f"ç¯å¢ƒæ¸©åº¦å¯¹ç»­èˆªæ—¶é—´çš„å½±å“ - {scenario_name}", fontweight='bold')
        ax.legend()
        ax.grid(True, alpha=0.3)
        
        # æ·»åŠ å‚è€ƒçº¿
        ax.axvline(x=25, color='green', linestyle='--', alpha=0.5, label='å®¤æ¸© (25Â°C)')
        
        plt.tight_layout()
        plt.show()
    
    if verbose:
        print("=" * 60)
    
    return results


def run_all_group_comparisons(n_mc=50, verbose=True):
    """
    è¿è¡Œæ‰€æœ‰é¢„å®šä¹‰åœºæ™¯ç»„çš„å¯¹æ¯”å®éªŒ
    """
    all_results = {}
    
    for group_name in SCENARIO_GROUPS.keys():
        if verbose:
            print(f"\n{'='*60}")
            print(f"åœºæ™¯ç»„: {group_name}")
            print('='*60)
        
        results = run_comparison_experiment(
            group_name=group_name,
            n_mc=n_mc,
            verbose=verbose,
            visualize=True,
            comprehensive_plot=True,
        )
        
        all_results[group_name] = results
    
    return all_results


def run_quick_demo():
    """
    å¿«é€Ÿæ¼”ç¤ºåœºæ™¯å¯¹æ¯”
    """
    print("\n" + "ğŸš€ å¿«é€Ÿæ¼”ç¤ºï¼šåœºæ™¯å¯¹æ¯”åˆ†æ\n")
    
    # æ—¥å¸¸åœºæ™¯å¯¹æ¯”
    results = run_comparison_experiment(
        group_name="æ—¥å¸¸åœºæ™¯",
        n_mc=50,
        verbose=True,
        visualize=True,
        comprehensive_plot=True,
        include_timeline=True,
    )
    
    print("\nè¿›è¡Œæç«¯åœºæ™¯å¯¹æ¯”...")
    
    # æç«¯åœºæ™¯å¯¹æ¯”
    results_extreme = run_comparison_experiment(
        group_name="æç«¯åœºæ™¯",
        n_mc=50,
        verbose=True,
        visualize=True,
        comprehensive_plot=True,
    )


if __name__ == "__main__":
    run_quick_demo()


==== src/experiments\exp_monte_carlo.py ====

# experiments/exp_monte_carlo.py
# Monte Carlo ä»¿çœŸå®éªŒæ¨¡å—
#
# æä¾› Monte Carlo ä»¿çœŸå®éªŒåŠŸèƒ½ï¼š
# - æ‰¹é‡éšæœºä»¿çœŸ
# - ç»Ÿè®¡åˆ†æ
# - åˆ†å¸ƒå¯è§†åŒ–

import sys
import os
import numpy as np

# æ·»åŠ  src ç›®å½•åˆ°è·¯å¾„
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from simulate import run_monte_carlo
from visualization import (
    plot_ttl_distribution,
    plot_ttl_boxplot,
    plot_ttl_violin,
    plot_ttl_kde,
    plot_ttl_statistical_summary,
)
from usage.scenario import *


def run_monte_carlo_experiment(
    scenario=None,
    scenario_name="é»˜è®¤åœºæ™¯",
    n_samples=100,
    base_seed=0,
    dt=1.0,
    T_amb=298.15,
    verbose=True,
    visualize=True,
    summary_plot=False,
    save_prefix=None,
):
    """
    è¿è¡Œ Monte Carlo ä»¿çœŸå®éªŒ
    
    å‚æ•°ï¼š
        scenario : dict - ä½¿ç”¨åœºæ™¯é…ç½®
        scenario_name : str - åœºæ™¯åç§°
        n_samples : int - ä»¿çœŸæ¬¡æ•°
        base_seed : int - åŸºç¡€éšæœºç§å­
        dt : float - æ—¶é—´æ­¥é•¿ï¼ˆç§’ï¼‰
        T_amb : float - ç¯å¢ƒæ¸©åº¦ï¼ˆKï¼‰
        verbose : bool - æ˜¯å¦è¾“å‡ºè¯¦ç»†ä¿¡æ¯
        visualize : bool - æ˜¯å¦å¯è§†åŒ–ç»“æœ
        summary_plot : bool - æ˜¯å¦æ˜¾ç¤ºç»¼åˆç»Ÿè®¡å›¾
        save_prefix : str - å›¾ç‰‡ä¿å­˜è·¯å¾„å‰ç¼€
    
    è¿”å›ï¼š
        results : dict - ä»¿çœŸç»“æœ
            {
                "ttl_list": [...],
                "mean": float,
                "std": float,
                "min": float,
                "max": float,
                "median": float,
                "q1": float,
                "q3": float,
            }
    """
    
    # é»˜è®¤åœºæ™¯
    if scenario is None:
        scenario = SCENARIO_STUDENT_DAILY_MIXED
        scenario_name = "å­¦ç”Ÿæ—¥å¸¸æ··åˆåœºæ™¯"
    
    if verbose:
        print("=" * 60)
        print("ğŸ² Monte Carlo ä»¿çœŸå®éªŒ")
        print("=" * 60)
        print(f"åœºæ™¯: {scenario_name}")
        print(f"ä»¿çœŸæ¬¡æ•°: {n_samples}")
        print(f"åŸºç¡€ç§å­: {base_seed}")
        print(f"æ—¶é—´æ­¥é•¿: {dt} ç§’")
        print(f"ç¯å¢ƒæ¸©åº¦: {T_amb - 273.15:.1f} Â°C")
        print("-" * 60)
        print("æ­£åœ¨è¿è¡Œ Monte Carlo ä»¿çœŸ...")
    
    # è¿è¡Œ Monte Carlo ä»¿çœŸ
    ttl_list = run_monte_carlo(
        scenario=scenario,
        n_samples=n_samples,
        base_seed=base_seed,
        dt=dt,
        T_amb=T_amb,
    )
    
    # è½¬æ¢ä¸ºå°æ—¶ç”¨äºç»Ÿè®¡
    ttl_hours = [t / 3600 for t in ttl_list]
    
    # è®¡ç®—ç»Ÿè®¡é‡
    results = {
        "ttl_list": ttl_list,
        "mean": np.mean(ttl_list),
        "std": np.std(ttl_list),
        "min": np.min(ttl_list),
        "max": np.max(ttl_list),
        "median": np.median(ttl_list),
        "q1": np.percentile(ttl_list, 25),
        "q3": np.percentile(ttl_list, 75),
    }
    
    # è¾“å‡ºç»“æœæ‘˜è¦
    if verbose:
        print("-" * 60)
        print("âœ… Monte Carlo ä»¿çœŸå®Œæˆï¼")
        print("-" * 60)
        print(f"ğŸ“Š ç»Ÿè®¡æ‘˜è¦:")
        print(f"   æ ·æœ¬æ•°: {n_samples}")
        print(f"   å¹³å‡ TTL: {results['mean']/3600:.2f} å°æ—¶")
        print(f"   æ ‡å‡†å·®: {results['std']/3600:.3f} å°æ—¶")
        print(f"   æœ€å° TTL: {results['min']/3600:.2f} å°æ—¶")
        print(f"   æœ€å¤§ TTL: {results['max']/3600:.2f} å°æ—¶")
        print(f"   ä¸­ä½æ•°: {results['median']/3600:.2f} å°æ—¶")
        print(f"   25% åˆ†ä½: {results['q1']/3600:.2f} å°æ—¶")
        print(f"   75% åˆ†ä½: {results['q3']/3600:.2f} å°æ—¶")
        
        # 95% ç½®ä¿¡åŒºé—´
        ci_low = results['mean'] - 1.96 * results['std'] / np.sqrt(n_samples)
        ci_high = results['mean'] + 1.96 * results['std'] / np.sqrt(n_samples)
        print(f"   95% ç½®ä¿¡åŒºé—´: [{ci_low/3600:.3f}, {ci_high/3600:.3f}] å°æ—¶")
        print("=" * 60)
    
    # å¯è§†åŒ–
    if visualize:
        if summary_plot:
            # ç»¼åˆç»Ÿè®¡å›¾
            save_path = f"{save_prefix}_mc_summary.png" if save_prefix else None
            plot_ttl_statistical_summary(ttl_list, save_path=save_path)
        else:
            # ç®€å•ç›´æ–¹å›¾
            save_path = f"{save_prefix}_mc_hist.png" if save_prefix else None
            plot_ttl_distribution(ttl_list, save_path=save_path)
    
    return results


def run_convergence_analysis(
    scenario=None,
    scenario_name="é»˜è®¤åœºæ™¯",
    max_samples=500,
    step=50,
    base_seed=0,
    verbose=True,
    visualize=True,
):
    """
    è¿è¡Œæ”¶æ•›æ€§åˆ†æï¼ˆåˆ†æä¸åŒæ ·æœ¬é‡å¯¹ç»“æœçš„å½±å“ï¼‰
    
    å‚æ•°ï¼š
        scenario : dict - ä½¿ç”¨åœºæ™¯é…ç½®
        scenario_name : str - åœºæ™¯åç§°
        max_samples : int - æœ€å¤§æ ·æœ¬æ•°
        step : int - æ ·æœ¬æ•°æ­¥é•¿
        base_seed : int - åŸºç¡€éšæœºç§å­
        verbose : bool - æ˜¯å¦è¾“å‡ºè¯¦ç»†ä¿¡æ¯
        visualize : bool - æ˜¯å¦å¯è§†åŒ–ç»“æœ
    
    è¿”å›ï¼š
        convergence_results : dict - æ”¶æ•›åˆ†æç»“æœ
    """
    import matplotlib.pyplot as plt
    
    if scenario is None:
        scenario = SCENARIO_STUDENT_DAILY_MIXED
        scenario_name = "å­¦ç”Ÿæ—¥å¸¸æ··åˆåœºæ™¯"
    
    if verbose:
        print("=" * 60)
        print("ğŸ“ˆ Monte Carlo æ”¶æ•›æ€§åˆ†æ")
        print("=" * 60)
        print(f"åœºæ™¯: {scenario_name}")
        print(f"æœ€å¤§æ ·æœ¬æ•°: {max_samples}")
        print("-" * 60)
    
    sample_sizes = list(range(step, max_samples + 1, step))
    means = []
    stds = []
    ci_lows = []
    ci_highs = []
    
    # ä¸€æ¬¡æ€§è¿è¡Œæœ€å¤§æ ·æœ¬
    all_ttl = run_monte_carlo(
        scenario=scenario,
        n_samples=max_samples,
        base_seed=base_seed,
    )
    
    for n in sample_sizes:
        ttl_subset = all_ttl[:n]
        mean = np.mean(ttl_subset)
        std = np.std(ttl_subset)
        
        means.append(mean / 3600)
        stds.append(std / 3600)
        ci_lows.append((mean - 1.96 * std / np.sqrt(n)) / 3600)
        ci_highs.append((mean + 1.96 * std / np.sqrt(n)) / 3600)
        
        if verbose:
            print(f"  n={n:4d}: å‡å€¼={mean/3600:.3f}h, æ ‡å‡†å·®={std/3600:.4f}h")
    
    convergence_results = {
        "sample_sizes": sample_sizes,
        "means": means,
        "stds": stds,
        "ci_lows": ci_lows,
        "ci_highs": ci_highs,
    }
    
    if visualize:
        fig, axes = plt.subplots(1, 2, figsize=(14, 5))
        
        # å‡å€¼æ”¶æ•›å›¾
        ax1 = axes[0]
        ax1.plot(sample_sizes, means, 'b-', linewidth=2, label='å‡å€¼')
        ax1.fill_between(sample_sizes, ci_lows, ci_highs, alpha=0.3, color='blue', label='95% CI')
        ax1.axhline(y=means[-1], color='red', linestyle='--', alpha=0.7, label=f'æœ€ç»ˆå‡å€¼: {means[-1]:.3f}h')
        ax1.set_xlabel("æ ·æœ¬æ•°")
        ax1.set_ylabel("TTL å‡å€¼ (å°æ—¶)")
        ax1.set_title("å‡å€¼æ”¶æ•›æ€§")
        ax1.legend()
        ax1.grid(True, alpha=0.3)
        
        # æ ‡å‡†å·®æ”¶æ•›å›¾
        ax2 = axes[1]
        ax2.plot(sample_sizes, stds, 'g-', linewidth=2, label='æ ‡å‡†å·®')
        ax2.set_xlabel("æ ·æœ¬æ•°")
        ax2.set_ylabel("TTL æ ‡å‡†å·® (å°æ—¶)")
        ax2.set_title("æ ‡å‡†å·®ç¨³å®šæ€§")
        ax2.legend()
        ax2.grid(True, alpha=0.3)
        
        fig.suptitle(f"Monte Carlo æ”¶æ•›æ€§åˆ†æ - {scenario_name}", fontsize=14, fontweight='bold')
        plt.tight_layout()
        plt.show()
    
    if verbose:
        print("=" * 60)
    
    return convergence_results


def run_quick_demo():
    """
    å¿«é€Ÿæ¼”ç¤º Monte Carlo ä»¿çœŸ
    """
    print("\n" + "ğŸš€ å¿«é€Ÿæ¼”ç¤ºï¼šMonte Carlo ä»¿çœŸ\n")
    
    # åŸºç¡€ Monte Carlo
    results = run_monte_carlo_experiment(
        scenario=SCENARIO_STUDENT_DAILY_MIXED,
        scenario_name="å­¦ç”Ÿæ—¥å¸¸",
        n_samples=200,
        verbose=True,
        visualize=True,
        summary_plot=True,
    )
    
    print("\nè¿›è¡Œæ”¶æ•›æ€§åˆ†æ...")
    convergence_analysis = run_convergence_analysis(
        scenario=SCENARIO_STUDENT_DAILY_MIXED,
        scenario_name="å­¦ç”Ÿæ—¥å¸¸",
        max_samples=300,
        step=30,
        verbose=True,
        visualize=True,
    )


if __name__ == "__main__":
    run_quick_demo()


==== src/experiments\exp_sensitivity.py ====

# experiments/exp_sensitivity.py
# æ•æ„Ÿåº¦åˆ†æå®éªŒæ¨¡å—
#
# æä¾›æ•æ„Ÿåº¦åˆ†æå®éªŒåŠŸèƒ½ï¼š
# - å‚æ•°æ•æ„Ÿåº¦åˆ†æ
# - å¤šç§å¯è§†åŒ–æ–¹å¼
# - åˆ†ææŠ¥å‘Šç”Ÿæˆ

import sys
import os
import copy

# æ·»åŠ  src ç›®å½•åˆ°è·¯å¾„
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from simulate import run_monte_carlo
from usage.state import USAGE_STATES
from visualization import (
    plot_sensitivity_bar,
    plot_sensitivity_tornado,
    plot_sensitivity_spider,
    plot_sensitivity_heatmap,
)
from visualization.sensitivity_plot import plot_sensitivity_comprehensive
from usage.scenario import *


# =====================================================
# å¯åˆ†æçš„æ•æ„Ÿåº¦å‚æ•°
# =====================================================

SENS_PARAMS = [
    "u",            # å±å¹•äº®åº¦
    "r",            # åˆ·æ–°ç‡
    "u_cpu",        # CPU åˆ©ç”¨ç‡
    "lambda_cell",  # èœ‚çªæ¯”ä¾‹
    "delta_signal", # ä¿¡å·è´¨é‡
    "r_on",         # GPS å¼€å¯æ¯”ä¾‹
]

PARAM_DESCRIPTIONS = {
    "u": "å±å¹•äº®åº¦",
    "r": "åˆ·æ–°ç‡",
    "u_cpu": "CPU åˆ©ç”¨ç‡",
    "lambda_cell": "èœ‚çªç½‘ç»œæ¯”ä¾‹",
    "delta_signal": "ä¿¡å·è´¨é‡ä¿®æ­£",
    "r_on": "GPS å¼€å¯æ¯”ä¾‹",
}


def _perturb_usage(param, factor):
    """
    å¯¹æ‰€æœ‰ usage çŠ¶æ€çš„æŸä¸ªå‚æ•°è¿›è¡Œæ¯”ä¾‹æ‰°åŠ¨
    """
    for state in USAGE_STATES.values():
        if param in state:
            state[param] *= factor


def run_sensitivity_experiment(
    scenario=None,
    scenario_name="é»˜è®¤åœºæ™¯",
    param_list=None,
    eps=0.2,
    n_mc=100,
    verbose=True,
    visualize=True,
    comprehensive_plot=False,
    save_prefix=None,
):
    """
    è¿è¡Œæ•æ„Ÿåº¦åˆ†æå®éªŒ
    
    å‚æ•°ï¼š
        scenario : dict - ä½¿ç”¨åœºæ™¯é…ç½®
        scenario_name : str - åœºæ™¯åç§°
        param_list : list - è¦åˆ†æçš„å‚æ•°åˆ—è¡¨
        eps : float - æ‰°åŠ¨æ¯”ä¾‹ï¼ˆé»˜è®¤ Â±20%ï¼‰
        n_mc : int - æ¯æ¬¡æ‰°åŠ¨çš„ Monte Carlo æ ·æœ¬æ•°
        verbose : bool - æ˜¯å¦è¾“å‡ºè¯¦ç»†ä¿¡æ¯
        visualize : bool - æ˜¯å¦å¯è§†åŒ–ç»“æœ
        comprehensive_plot : bool - æ˜¯å¦æ˜¾ç¤ºç»¼åˆåˆ†æå›¾
        save_prefix : str - å›¾ç‰‡ä¿å­˜è·¯å¾„å‰ç¼€
    
    è¿”å›ï¼š
        results : dict - æ•æ„Ÿåº¦åˆ†æç»“æœ
    """
    
    # é»˜è®¤åœºæ™¯
    if scenario is None:
        scenario = SCENARIO_STUDENT_DAILY_MARKOV
        scenario_name = "å­¦ç”Ÿæ—¥å¸¸ Markov åœºæ™¯"
    
    # é»˜è®¤å‚æ•°åˆ—è¡¨
    if param_list is None:
        param_list = SENS_PARAMS
    
    if verbose:
        print("=" * 60)
        print("ğŸ“Š æ•æ„Ÿåº¦åˆ†æå®éªŒ")
        print("=" * 60)
        print(f"åœºæ™¯: {scenario_name}")
        print(f"æ‰°åŠ¨å¹…åº¦: Â±{eps*100:.0f}%")
        print(f"Monte Carlo æ ·æœ¬æ•°: {n_mc}")
        print(f"åˆ†æå‚æ•°: {[PARAM_DESCRIPTIONS.get(p, p) for p in param_list]}")
        print("-" * 60)
    
    # ä¿å­˜åŸå§‹ usage å‚æ•°
    original_states = copy.deepcopy(USAGE_STATES)
    
    # è®¡ç®—åŸºå‡† TTL
    if verbose:
        print("è®¡ç®—åŸºå‡† TTL...")
    
    ttl_base_list = run_monte_carlo(scenario, n_samples=n_mc)
    ttl_base = sum(ttl_base_list) / n_mc
    
    if verbose:
        print(f"åŸºå‡† TTL: {ttl_base/3600:.2f} å°æ—¶")
        print("-" * 60)
    
    results = {}
    
    for p in param_list:
        if verbose:
            print(f"åˆ†æå‚æ•°: {PARAM_DESCRIPTIONS.get(p, p)}...")
        
        # æ­£æ‰°åŠ¨
        _perturb_usage(p, 1 + eps)
        ttl_plus_list = run_monte_carlo(scenario, n_samples=n_mc)
        ttl_plus = sum(ttl_plus_list) / n_mc
        
        # æ¢å¤
        USAGE_STATES.clear()
        USAGE_STATES.update(copy.deepcopy(original_states))
        
        # è´Ÿæ‰°åŠ¨
        _perturb_usage(p, 1 - eps)
        ttl_minus_list = run_monte_carlo(scenario, n_samples=n_mc)
        ttl_minus = sum(ttl_minus_list) / n_mc
        
        # æ¢å¤
        USAGE_STATES.clear()
        USAGE_STATES.update(copy.deepcopy(original_states))
        
        # ä¸­å¿ƒå·®åˆ†æ•æ„Ÿåº¦
        S = (ttl_plus - ttl_minus) / (2 * eps)
        
        # å½’ä¸€åŒ–æ•æ„Ÿåº¦
        S_norm = S / ttl_base
        
        results[p] = {
            "TTL+": ttl_plus,
            "TTL-": ttl_minus,
            "S": S,
            "S_norm": S_norm,
        }
        
        if verbose:
            print(f"  TTL+{eps*100:.0f}%: {ttl_plus/3600:.2f} h")
            print(f"  TTL-{eps*100:.0f}%: {ttl_minus/3600:.2f} h")
            print(f"  å½’ä¸€åŒ–æ•æ„Ÿåº¦: {S_norm:.4f}")
    
    if verbose:
        print("-" * 60)
        print("âœ… æ•æ„Ÿåº¦åˆ†æå®Œæˆï¼")
        print("-" * 60)
        
        # æ’åºè¾“å‡º
        sorted_params = sorted(results.keys(), key=lambda p: abs(results[p]["S_norm"]), reverse=True)
        print("ğŸ“ˆ æ•æ„Ÿåº¦æ’åï¼ˆæŒ‰ç»å¯¹å€¼ï¼‰:")
        for i, p in enumerate(sorted_params, 1):
            sign = "+" if results[p]["S_norm"] > 0 else "-"
            print(f"  {i}. {PARAM_DESCRIPTIONS.get(p, p)}: {sign}{abs(results[p]['S_norm']):.4f}")
        
        print("=" * 60)
    
    # å¯è§†åŒ–
    if visualize:
        if comprehensive_plot:
            # ç»¼åˆåˆ†æå›¾
            save_path = f"{save_prefix}_sens_comprehensive.png" if save_prefix else None
            plot_sensitivity_comprehensive(results, ttl_base, save_path=save_path)
        else:
            # ç®€å•æŸ±çŠ¶å›¾
            save_path = f"{save_prefix}_sens_bar.png" if save_prefix else None
            plot_sensitivity_bar(results, save_path=save_path)
    
    # æ·»åŠ åŸºå‡† TTL åˆ°ç»“æœ
    results["_baseline_ttl"] = ttl_base
    
    return results


def run_multi_eps_sensitivity(
    scenario=None,
    scenario_name="é»˜è®¤åœºæ™¯",
    param_list=None,
    eps_list=None,
    n_mc=50,
    verbose=True,
    visualize=True,
):
    """
    è¿è¡Œå¤šæ‰°åŠ¨å¹…åº¦æ•æ„Ÿåº¦åˆ†æ
    
    å‚æ•°ï¼š
        scenario : dict - ä½¿ç”¨åœºæ™¯é…ç½®
        scenario_name : str - åœºæ™¯åç§°
        param_list : list - è¦åˆ†æçš„å‚æ•°åˆ—è¡¨
        eps_list : list - æ‰°åŠ¨å¹…åº¦åˆ—è¡¨
        n_mc : int - Monte Carlo æ ·æœ¬æ•°
        verbose : bool - æ˜¯å¦è¾“å‡ºè¯¦ç»†ä¿¡æ¯
        visualize : bool - æ˜¯å¦å¯è§†åŒ–ç»“æœ
    
    è¿”å›ï¼š
        multi_results : dict - å¤šæ‰°åŠ¨å¹…åº¦åˆ†æç»“æœ
    """
    import matplotlib.pyplot as plt
    import numpy as np
    
    if scenario is None:
        scenario = SCENARIO_STUDENT_DAILY_MARKOV
        scenario_name = "å­¦ç”Ÿæ—¥å¸¸ Markov åœºæ™¯"
    
    if param_list is None:
        param_list = SENS_PARAMS[:3]  # é»˜è®¤åªåˆ†æå‰ä¸‰ä¸ªå‚æ•°
    
    if eps_list is None:
        eps_list = [0.05, 0.10, 0.15, 0.20, 0.25, 0.30]
    
    if verbose:
        print("=" * 60)
        print("ğŸ“Š å¤šæ‰°åŠ¨å¹…åº¦æ•æ„Ÿåº¦åˆ†æ")
        print("=" * 60)
        print(f"åœºæ™¯: {scenario_name}")
        print(f"æ‰°åŠ¨å¹…åº¦: {[f'{e*100:.0f}%' for e in eps_list]}")
        print("-" * 60)
    
    multi_results = {p: {"eps": [], "S_norm": []} for p in param_list}
    
    for eps in eps_list:
        if verbose:
            print(f"\næ‰°åŠ¨å¹…åº¦ Â±{eps*100:.0f}%:")
        
        results = run_sensitivity_experiment(
            scenario=scenario,
            param_list=param_list,
            eps=eps,
            n_mc=n_mc,
            verbose=False,
            visualize=False,
        )
        
        for p in param_list:
            multi_results[p]["eps"].append(eps * 100)
            multi_results[p]["S_norm"].append(results[p]["S_norm"])
            
            if verbose:
                print(f"  {PARAM_DESCRIPTIONS.get(p, p)}: S_norm = {results[p]['S_norm']:.4f}")
    
    if visualize:
        fig, ax = plt.subplots(figsize=(10, 6))
        
        colors = ['#2E86AB', '#A23B72', '#F18F01', '#28A745', '#DC3545', '#6C757D']
        
        for i, p in enumerate(param_list):
            ax.plot(multi_results[p]["eps"], multi_results[p]["S_norm"], 
                    'o-', color=colors[i % len(colors)], linewidth=2, markersize=8,
                    label=PARAM_DESCRIPTIONS.get(p, p))
        
        ax.axhline(y=0, color='black', linestyle='-', linewidth=0.5)
        ax.set_xlabel("æ‰°åŠ¨å¹…åº¦ (%)")
        ax.set_ylabel("å½’ä¸€åŒ–æ•æ„Ÿåº¦")
        ax.set_title(f"æ•æ„Ÿåº¦ä¸æ‰°åŠ¨å¹…åº¦å…³ç³» - {scenario_name}", fontweight='bold')
        ax.legend()
        ax.grid(True, alpha=0.3)
        
        plt.tight_layout()
        plt.show()
    
    if verbose:
        print("=" * 60)
    
    return multi_results


def run_quick_demo():
    """
    å¿«é€Ÿæ¼”ç¤ºæ•æ„Ÿåº¦åˆ†æ
    """
    print("\n" + "ğŸš€ å¿«é€Ÿæ¼”ç¤ºï¼šæ•æ„Ÿåº¦åˆ†æ\n")
    
    # åŸºç¡€æ•æ„Ÿåº¦åˆ†æ
    results = run_sensitivity_experiment(
        scenario=SCENARIO_STUDENT_DAILY_MARKOV,
        scenario_name="å­¦ç”Ÿæ—¥å¸¸ Markov",
        n_mc=50,  # æ¼”ç¤ºç”¨è¾ƒå°‘æ ·æœ¬
        verbose=True,
        visualize=True,
        comprehensive_plot=True,
    )


if __name__ == "__main__":
    run_quick_demo()


==== src/experiments\__init__.py ====

# experiments/__init__.py
# å®éªŒæ¨¡å—åˆå§‹åŒ–
#
# æä¾›ç»Ÿä¸€çš„å®éªŒå…¥å£æ¥å£ï¼ŒåŒ…å«ï¼š
# - åŸºç¡€ä»¿çœŸå®éªŒ
# - Monte Carlo ä»¿çœŸå®éªŒ
# - æ•æ„Ÿåº¦åˆ†æå®éªŒ
# - åœºæ™¯å¯¹æ¯”å®éªŒ

from .exp_basic import run_basic_experiment
from .exp_monte_carlo import run_monte_carlo_experiment
from .exp_sensitivity import run_sensitivity_experiment
from .exp_compare import run_comparison_experiment

__all__ = [
    "run_basic_experiment",
    "run_monte_carlo_experiment",
    "run_sensitivity_experiment",
    "run_comparison_experiment",
]
